---
- name: Install Kitty
  block:

    - name: Directories present
      ansible.builtin.file:
        path: "{{ dir }}"
        state: directory
        mode: 0750
      loop:
        - "{{ kitty_bin }}"
        - "{{ kitty_local }}"
        - "{{ kitty_tmp }}"
      loop_control:
        loop_var: dir

    - name: GPG public key present
      ansible.builtin.copy:
        src: kovid.gpg
        dest: "{{ kitty_tmp }}/kovid.gpg"
        mode: 0600

    - name: GPG key imported
      ansible.builtin.command: "gpg --import {{ kitty_tmp }}/kovid.gpg"
      register: kitty_gpg_import
      changed_when: ( "unchanged" not in kitty_gpg_import.stderr ) or ( "not changed" not in kitty_gpg_import.stderr )

    - name: Check the latest version of Kitty
      ansible.builtin.uri:
        url: https://github.com/kovidgoyal/kitty/releases/latest
        method: HEAD
        status_code: 302
        follow_redirects: none
      check_mode: false
      changed_when: false
      register: kitty_headers

    - name: Set a fact for the latest version of Kitty
      ansible.builtin.set_fact:
        kitty_latest: "{{ kitty_headers.location | urlsplit('path') | basename | regex_replace('^v') }}"

    - name: Check if Kitty is installed
      ansible.builtin.stat:
        path: "{{ kitty_bin }}/kitty"
      register: kitty_present

    - name: Check Kitty version
      block:

        - name: Check Kitty version
          ansible.builtin.command: "{{ kitty_bin }}/kitty --version"
          changed_when: false
          check_mode: false
          register: kitty_installed_version

        - name: Set a variable for the installed version of Kitty
          ansible.builtin.set_fact:
            kitty_installed: "{{ kitty_installed_version.stdout.split(' ')[1] | trim | string }}"

        - name: Set a fact to indicate that Kitty can be upgraded
          ansible.builtin.set_fact:
            kitty_upgradable: true
          when: kitty_installed is version(kitty_latest, '<')

        - name: The latest version of Kitty is already installed
          ansible.builtin.debug:
            msg:
              - "The latest version of Kitty, {{ kitty_latest }}, is alreay installed."
          when: kitty_installed is version(kitty_latest, '==')

      when: ( kitty_present is defined ) and ( kitty_present.stat.exists | bool )

    - name: Install Kitty
      block:

        - name: Download Kitty GPG sig
          ansible.builtin.get_url:
            url: "https://github.com/kovidgoyal/kitty/releases/download/v{{ kitty_latest }}/kitty-{{ kitty_latest }}-x86_64.txz.sig"
            dest: "{{ kitty_tmp }}/kitty-{{ kitty_latest }}-x86_64.txz.sig"
            mode: 0644

        - name: Download Kitty
          ansible.builtin.get_url:
            url: "https://github.com/kovidgoyal/kitty/releases/download/v{{ kitty_latest }}/kitty-{{ kitty_latest }}-x86_64.txz"
            dest: "{{ kitty_tmp }}/kitty-{{ kitty_latest }}-x86_64.txz"
            mode: 0644

        - name: Check GPG sig
          ansible.builtin.command: "gpg --verify {{ kitty_tmp }}/kitty-{{ kitty_latest }}-x86_64.txz.sig"
          register: kitty_gpg_verify
          changed_when: false
          failed_when: ( "Good signature" not in kitty_gpg_verify.stderr )

        - name: Unarchive Kitty
          ansible.builtin.unarchive:
            src: "{{ kitty_tmp }}/kitty-{{ kitty_latest }}-x86_64.txz"
            dest: "{{ kitty_local }}"
            remote_src: true

      when: ( ( kitty_present is defined ) and ( not kitty_present.stat.exists | bool ) ) or ( ( kitty_upgradable is defined ) and ( kitty_upgradable | bool ) )

  when: kitty | bool
  tags:
    - kitty
...
